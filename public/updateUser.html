<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update user</title>
    <link rel="stylesheet" href="./css/style.css">
</head>


<body>

    <header>
        <h1 id="updateUser">Update user</h1>

        <div class="dropdown">
            <button id="user" class="dropbtn"></button>
            <div class="dropdown-content">
                <button onclick="logout()">Logout</button>
                <button onclick="list()">Lists</button>
            </div>

    </header>


    <div class="update">
        <input type="text" id="newUsername">
        <button id="username">Update username</button>
        <input type="text" id="newPassword">
        <button id="password">Update password</button>
        <button id="delete">Delete user</button>
    </div>

    <p id="respTxt"></p>

</body>

<script>

    const newUsername = document.getElementById("newUsername");
    const newPassword = document.getElementById("newPassword");
    const respTxt = document.getElementById("respTxt");
    const user = document.getElementById("user");

    let logindataJson = localStorage.getItem("logindata");
    if (logindataJson === null) {
        logindataJson = '{"token":"null"}';
    }
    let logindata = JSON.parse(logindataJson);
    let logindataString = JSON.stringify(logindata.token);

    //Viser hvem som er logget inn
    let greetings = ["Hello ", "Howdy ", "Hey ", "Greetings ", "Welcome ", "Hiya ", "Ahoy ", "Bonjour ", "Hola ", "Aloha ", "Hai ", "Hei ", "Sup ", "How you doing ", "Ay yo ", "Wassap ", "I see you ", "I'm watching you "];
    let randomGreet = Math.floor(Math.random() * greetings.length);
    user.innerHTML = greetings[randomGreet] + logindata.username;


    function list() {
        location.href = "./tasks.html";
    }

    loadData();
    async function loadData() {

        let config = {
            method: "GET",
            headers: {
                "authorization": logindataString
            }
        }
        try {
            let response = await fetch("/tasks", config);
            let data = await response.json();
            console.log(data)
            if (response.status === 403) {
                location.href = "./userLogin.html";
            }
        }
        catch (err) {
            console.log("Something went wrong.");
        }
    }

    document.getElementById("username").onclick = async function (evt) {

        if (newUsername.value.length <= 3) {
            alert("Username must be at least 3 digits long");
            return;
        }
        let body = {
            username: newUsername.value
        }
        let config = {
            method: "PUT",
            headers: {
                "content-type": "application/json",
                "authorization": logindataString
            },
            body: JSON.stringify(body)
        }

        try {
            let response = await fetch("/user/updateUsername", config);
            let data = await response.json();
            if (response.status === 200) {
                respTxt.innerText = "Username updated"
                logindata['username'] = newUsername.value;
                localStorage.setItem('logindata', JSON.stringify(logindata));
            }
        }
        catch (err) {
            console.log("Something went wrong.")
        }
        window.location.reload();
    }

    document.getElementById("password").onclick = async function (evt) {

        if (newPassword.value.length < 6) {
            alert("Password must be at least 6 digits long");
            return;
        }
        let body = {
            password: newPassword.value
        }
        let config = {
            method: "PUT",
            headers: {
                "content-type": "application/json",
                "authorization": logindataString
            },
            body: JSON.stringify(body)
        }

        try {
            let response = await fetch("/user/updatePassword", config);
            let data = await response.json();
            if (response.status === 200) {
                respTxt.innerText = "Password updated"
            }
        }
        catch (err) {
            console.log("Something went wrong.")
        }
        window.location.reload();
    }

    document.getElementById("password").onclick = async function (evt) {

        let body = {
            password: newPassword.value
        }
        let config = {
            method: "PUT",
            headers: {
                "content-type": "application/json",
                "authorization": logindataString
            },
            body: JSON.stringify(body)
        }

        try {
            let response = await fetch("/user/updatePassword", config);
            let data = await response.json();
            if (response.status === 200) {
                respTxt.innerText = "Password updated"
            }
        }
        catch (err) {
            console.log("Something went wrong.")
        }
        window.location.reload();
    }

</script>